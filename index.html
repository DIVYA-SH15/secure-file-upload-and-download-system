<!DOCTYPE html>
<html>
<head>
    <title>Secure File Upload System</title>
    <style>
        body { font-family: Arial; margin: 30px; }

        .upload-box {
            width: 350px;
            padding: 20px;
            border-radius: 10px;
            background: #f7f7ff;
            border: 1px solid #ccc;
            margin-bottom: 30px;
        }

        table {
            width: 80%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #eaeaea;
        }
        button {
            padding: 6px 12px;
            cursor: pointer;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 6px;
            margin-right: 5px;
        }
        button:hover {
            background: #357ABD;
        }
    </style>
</head>

<body>

    <h2>Secure File Upload System</h2>

    <div class="upload-box">
        <form id="uploadForm" enctype="multipart/form-data">
            <label><b>Select a file:</b></label><br><br>
            <input type="file" id="fileInput" name="file" required />
            <br><br>
            <button type="submit">Upload</button>
        </form>
        <p id="message" style="color:green"></p>
    </div>

    <h3>Uploaded Files</h3>
    <table id="fileTable">
        <tr>
            <th>File Name</th>
            <th>Size (KB)</th>
            <th>Date</th>
            <th>Actions</th>
        </tr>
    </table>

<script>
    // Upload file
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = document.getElementById("fileInput").files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        try {
            const res = await fetch("/upload", {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            document.getElementById("message").innerText = data.message;

            // Clear the file input
            document.getElementById("fileInput").value = "";

            // Reload file list
            loadFiles();
        } catch (err) {
            console.error(err);
            document.getElementById("message").innerText = "Upload failed";
        }
    });

    // Delete file
    async function deleteFile(fileId) {
        if (!confirm("Are you sure you want to delete this file?")) return;

        try {
            const res = await fetch(`/files/${fileId}`, { method: "DELETE" });
            const data = await res.json();
            alert(data.message);
            loadFiles();
        } catch (err) {
            console.error("Delete failed:", err);
            alert("Failed to delete file");
        }
    }

    // Load files into table
    async function loadFiles() {
        try {
            const res = await fetch("/files");
            const files = await res.json();

            const table = document.getElementById("fileTable");
            table.innerHTML = `
                <tr>
                    <th>File Name</th>
                    <th>Size (KB)</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            `;

            files.forEach(f => {
                table.innerHTML += `
                    <tr>
                        <td>${f.originalName}</td>
                        <td>${(f.size / 1024).toFixed(2)}</td>
                        <td>${new Date(f.createdAt).toLocaleString()}</td>
                        <td>
                            <a href="/download/${f.filename}">
                                <button>Download</button>
                            </a>
                            <button onclick="deleteFile('${f._id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
        } catch (err) {
            console.error("Error loading files:", err);
        }
    }

    // Load files on page load
    loadFiles();
</script>

</body>
</html>
